<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Almoxarifado • Fullstack</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.tab[aria-selected="true"]{background:#111827;color:#fff}.badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:12px}</style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4" id="app">
    <div id="login" class="min-h-[70vh] grid place-items-center">
      <div class="w-full max-w-md bg-white rounded-2xl shadow p-6">
        <h1 class="text-2xl font-semibold mb-2">Almoxarifado • Login</h1>
        <p class="text-sm text-slate-500 mb-4">Padrão: <b>admin / admin</b></p>
        <div class="space-y-3">
          <div><label class="text-sm">Usuário</label><input id="u" class="w-full border rounded-lg p-2" value="admin"></div>
          <div><label class="text-sm">Senha</label><input id="p" type="password" class="w-full border rounded-lg p-2" value="admin"></div>
          <div id="e" class="text-red-600 text-sm hidden">Falha no login</div>
          <button id="b" class="w-full bg-black text-white rounded-lg p-2">Entrar</button>
        </div>
      </div>
    </div>

    <div id="appview" class="hidden">
      <div class="flex items-center justify-between py-4">
        <div class="text-xl font-semibold">Almoxarifado • Fullstack</div>
        <div class="flex items-center gap-2">
          <span id="rb" class="badge bg-slate-900 text-white">ROLE</span>
          <span id="nm" class="text-sm">User</span>
          <button id="logout" class="border rounded-lg px-3 py-1">Sair</button>
        </div>
      </div>

      <div class="grid grid-cols-4 gap-2 mb-4">
        <button class="tab border rounded-lg px-3 py-2" data-t="itens">Ver Itens</button>
        <button class="tab border rounded-lg px-3 py-2" data-t="cad">Cadastrar Item</button>
        <button class="tab border rounded-lg px-3 py-2" data-t="sol">Solicitações</button>
        <button class="tab border rounded-lg px-3 py-2" data-t="usr">Usuários</button>
      </div>

      <div id="itens" class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center gap-2 mb-3">
          <input id="busca" class="border rounded-lg p-2 w-full" placeholder="Buscar por nome, código ou categoria">
        </div>
        <div id="itenslist" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        <div id="itensvazio" class="hidden text-center text-slate-500 py-8">Nenhum item.</div>
      </div>

      <div id="cad" class="bg-white rounded-2xl shadow p-4 hidden">
        <h2 class="text-lg font-semibold mb-4">Novo Item</h2>
        <form id="cadform" class="grid md:grid-cols-2 gap-3">
          <div><label class="text-sm">Nome</label><input name="name" class="border rounded-lg p-2 w-full" required></div>
          <div><label class="text-sm">Código</label><input name="code" class="border rounded-lg p-2 w-full"></div>
          <div><label class="text-sm">Categoria</label><input name="category" class="border rounded-lg p-2 w-full"></div>
          <div><label class="text-sm">Localização</label><input name="location" class="border rounded-lg p-2 w-full"></div>
          <div><label class="text-sm">Quantidade inicial</label><input name="qty" type="number" value="0" class="border rounded-lg p-2 w-full"></div>
          <div><label class="text-sm">Estoque mínimo</label><input name="min" type="number" value="0" class="border rounded-lg p-2 w-full"></div>
          <div class="md:col-span-2">
            <label class="text-sm">Imagem do item (opcional)</label>
            <input name="image" type="file" accept="image/*" class="border rounded-lg p-2 w-full">
          </div>
          <div class="md:col-span-2 flex justify-end">
            <button class="bg-black text-white rounded-lg px-4 py-2">Cadastrar</button>
          </div>
        </form>
      </div>

      <div id="sol" class="bg-white rounded-2xl shadow p-4 hidden">
        <div class="grid lg:grid-cols-3 gap-4">
          <div class="lg:col-span-1">
            <h2 class="text-lg font-semibold mb-3">Nova Solicitação</h2>
            <div class="space-y-3">
              <div><label class="text-sm">Item</label><select id="selitem" class="border rounded-lg p-2 w-full"></select></div>
              <div><label class="text-sm">Quantidade</label><input id="solqty" type="number" min="1" value="1" class="border rounded-lg p-2 w-full"></div>
              <div><label class="text-sm">Observações</label><input id="solobs" class="border rounded-lg p-2 w-full" placeholder="Ex: setor, urgência"></div>
              <button id="solbtn" class="bg-black text-white rounded-lg px-4 py-2">Solicitar</button>
            </div>
          </div>
          <div class="lg:col-span-2">
            <div id="reqlist" class="space-y-3"></div>
            <div id="reqvazio" class="hidden text-center text-slate-500 py-8">Nenhuma solicitação.</div>
          </div>
        </div>
      </div>

      <div id="usr" class="bg-white rounded-2xl shadow p-4 hidden">
        <div class="grid lg:grid-cols-3 gap-4">
          <div class="lg:col-span-1">
            <h2 class="text-lg font-semibold mb-3">Novo Usuário</h2>
            <div class="space-y-3">
              <div><label class="text-sm">Nome</label><input id="uname" class="border rounded-lg p-2 w-full"></div>
              <div><label class="text-sm">Usuário (login)</label><input id="uuser" class="border rounded-lg p-2 w-full"></div>
              <div><label class="text-sm">Senha</label><input id="upass" type="password" class="border rounded-lg p-2 w-full"></div>
              <div><label class="text-sm">Papel</label>
                <select id="urole" class="border rounded-lg p-2 w-full">
                  <option value="ADMIN">ADMIN</option>
                  <option value="ALMOX">ALMOX</option>
                  <option value="SOLICITANTE" selected>SOLICITANTE</option>
                </select>
              </div>
              <button id="ucreate" class="bg-black text-white rounded-lg px-4 py-2">Cadastrar</button>
            </div>
          </div>
          <div class="lg:col-span-2">
            <div id="userslist" class="space-y-3"></div>
            <div id="usersvazio" class="hidden text-center text-slate-500 py-8">Nenhum usuário.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const API = {
      async login(username,password){
        const r = await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
        if(!r.ok) throw new Error("login");
        return r.json();
      },
      async getItems(){ return fetchAuth("/api/items"); },
      async createItem(fd){
        const r = await fetch("/api/items",{method:"POST",headers:{Authorization:tokenHeader()},body:fd});
        if(!r.ok) throw new Error("create item");
        return r.json();
      },
      async adjustItem(id, delta){
        const r = await fetch("/api/items/"+id+"/adjust",{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:tokenHeader()},body:JSON.stringify({delta})});
        if(!r.ok) throw new Error("adjust");
        return r.json();
      },
      async getReqs(){ return fetchAuth("/api/requests"); },
      async createReq(payload){
        const r = await fetch("/api/requests",{method:"POST",headers:{"Content-Type":"application/json",Authorization:tokenHeader()},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error("req");
        return r.json();
      },
      async approveReq(id){
        const r = await fetch(`/api/requests/${id}/approve`,{method:"POST",headers:{Authorization:tokenHeader()}});
        if(!r.ok) throw new Error("approve");
        return r.json();
      },
      async rejectReq(id){
        const r = await fetch(`/api/requests/${id}/reject`,{method:"POST",headers:{Authorization:tokenHeader()}});
        if(!r.ok) throw new Error("reject");
        return r.json();
      },
      async getUsers(){ return fetchAuth("/api/users"); },
      async createUser(payload){
        const r = await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json",Authorization:tokenHeader()},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error("create user");
        return r.json();
      },
      async deleteUser(id){
        const r = await fetch(`/api/users/${id}`,{method:"DELETE",headers:{Authorization:tokenHeader()}});
        if(!r.ok) throw new Error("delete user");
        return r.json();
      }
    };
    function tokenHeader(){ return "Bearer "+(localStorage.getItem("token")||""); }
    async function fetchAuth(url){
      const r = await fetch(url,{headers:{Authorization:tokenHeader()}});
      if(!r.ok) throw new Error("auth");
      return r.json();
    }

    let currentUser = null;

    // login
    $("#b").addEventListener("click", async ()=>{
      try{
        const {token, user} = await API.login($("#u").value.trim(), $("#p").value.trim());
        localStorage.setItem("token", token);
        currentUser = user;
        $("#e").classList.add("hidden");
        $("#login").classList.add("hidden");
        $("#appview").classList.remove("hidden");
        $("#nm").textContent = user.name;
        $("#rb").textContent = user.role;
        renderAll();
      }catch(e){ $("#e").classList.remove("hidden"); }
    });
    $("#logout").addEventListener("click", ()=>{ localStorage.removeItem("token"); location.reload(); });

    // tabs
    $$(".tab").forEach(btn=>btn.addEventListener("click", ()=>{
      const t = btn.dataset.t;
      ["itens","cad","sol","usr"].forEach(id=>{ document.getElementById(id).classList.toggle("hidden", id!==t); });
      $$(".tab").forEach(b=>b.setAttribute("aria-selected", b===btn?"true":"false"));
    }));

    // items
    async function renderItems(){
      const items = await API.getItems();
      // search
      const q = ($("#busca").value||"").toLowerCase();
      const filtered = q? items.filter(i=>(i.name||"").toLowerCase().includes(q)||(i.code||"").toLowerCase().includes(q)||(i.category||"").toLowerCase().includes(q)) : items;
      const grid = $("#itenslist"); grid.innerHTML="";
      if(filtered.length===0){ $("#itensvazio").classList.remove("hidden"); } else { $("#itensvazio").classList.add("hidden"); }
      filtered.forEach(it=>{
        const el = document.createElement("div");
        el.className="border rounded-2xl p-3";
        el.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <div class="font-semibold truncate" title="${it.name}">${it.name}</div>
            <span class="badge bg-slate-100 text-slate-800">${it.category||"Sem categoria"}</span>
          </div>
          <div class="text-xs text-slate-500 mb-2">Código: <span class="font-mono">${it.code||"—"}</span></div>
          ${it.image_url? `<img src="${it.image_url}" class="w-full h-40 object-cover rounded-lg mb-2" />` : ""}
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm text-slate-500">Quantidade</div>
            <div class="text-2xl font-semibold">${it.qty}</div>
          </div>
          <div class="flex items-center justify-between text-sm mb-2">
            <div>Min: <b>${it.min||0}</b></div>
            <div>Local: <b>${it.location||"-"}</b></div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn-in border rounded-lg px-3 py-1 flex-1">Entrada</button>
            <button class="btn-out border rounded-lg px-3 py-1 flex-1">Baixa</button>
          </div>
        `;
        const isAlmox = currentUser && (currentUser.role==="ALMOX"||currentUser.role==="ADMIN");
        if(!isAlmox){ el.querySelectorAll(".btn-in,.btn-out").forEach(b=>b.setAttribute("disabled","true")); }
        else {
          el.querySelector(".btn-in").addEventListener("click", async ()=>{ await API.adjustItem(it.id, +1); renderItems(); });
          el.querySelector(".btn-out").addEventListener("click", async ()=>{
            const res = await API.adjustItem(it.id, -1);
            if(res.belowMin){ alert(`⚠️ Estoque do item "${it.name}" ficou abaixo do mínimo (${res.qty} < ${it.min}).`); }
            renderItems();
          });
        }
        grid.appendChild(el);
      });
    }
    $("#busca").addEventListener("input", ()=>renderItems());

    // cadastro item
    $("#cadform").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!(currentUser.role==="ALMOX"||currentUser.role==="ADMIN")){ alert("Apenas ALMOX/ADMIN cadastram itens."); return; }
      const fd = new FormData(e.target);
      await API.createItem(fd);
      e.target.reset();
      $$('.tab[data-t="itens"]')[0].click();
      renderItems(); renderSelectForReq();
    });

    // solicitações
    async function renderSelectForReq(){
      const items = await API.getItems();
      const sel = $("#selitem"); sel.innerHTML="";
      items.forEach(i=>{ const o=document.createElement("option"); o.value=i.id; o.textContent=`${i.name} (Disp: ${i.qty})`; sel.appendChild(o); });
    }
    async function renderReqs(){
      const reqs = await API.getReqs();
      const list = $("#reqlist"); list.innerHTML="";
      if(reqs.length===0) $("#reqvazio").classList.remove("hidden"); else $("#reqvazio").classList.add("hidden");
      reqs.forEach(r=>{
        const pill = r.status==="APROVADA"?"bg-green-600": r.status==="RECUSADA"?"bg-red-600":"bg-amber-600";
        const label = r.status==="APROVADA"?"Aprovada": r.status==="RECUSADA"?"Recusada":"Pendente";
        const el = document.createElement("div");
        el.className="border rounded-2xl p-3";
        el.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-2"><span class="font-semibold">${r.itemName}</span><span class="badge bg-slate-100 text-slate-800">Qtd: ${r.qty}</span></div>
            <span class="badge ${pill} text-white">${label}</span>
          </div>
          <div class="text-xs text-slate-500 mb-2">Por: <b>${r.createdBy}</b> • Em: ${new Date(r.createdAt).toLocaleString()}</div>
          <div class="text-sm text-slate-600 mb-2">${r.obs||"—"}</div>
          <div class="flex items-center gap-2">
            <button class="rec border rounded-lg px-3 py-1">Recusar</button>
            <button class="apr bg-black text-white rounded-lg px-3 py-1">Aprovar</button>
          </div>
        `;
        const isAlmox = currentUser && (currentUser.role==="ALMOX"||currentUser.role==="ADMIN");
        if(!isAlmox || r.status!=="PENDENTE"){ el.querySelectorAll(".rec,.apr").forEach(b=>b.setAttribute("disabled","true")); }
        else {
          el.querySelector(".rec").addEventListener("click", async ()=>{ await API.rejectReq(r.id); renderReqs(); });
          el.querySelector(".apr").addEventListener("click", async ()=>{
            const res = await API.approveReq(r.id);
            if(res.belowMin){ alert(`⚠️ Estoque do item "${r.itemName}" ficou abaixo do mínimo (${res.itemQty}).`); }
            renderItems(); renderReqs(); renderSelectForReq();
          });
        }
        list.appendChild(el);
      });
    }
    $("#solbtn").addEventListener("click", async ()=>{
      const itemId = $("#selitem").value, qty = Number($("#solqty").value||1), obs = $("#solobs").value.trim();
      await API.createReq({ itemId, qty, obs });
      $("#solqty").value=1; $("#solobs").value="";
      renderReqs();
    });

    // users
    async function renderUsers(){
      if(currentUser.role!=="ADMIN"){ $("#usr").classList.add("hidden"); return; }
      const users = await API.getUsers();
      const list = $("#userslist"); list.innerHTML="";
      if(users.length===0) $("#usersvazio").classList.remove("hidden"); else $("#usersvazio").classList.add("hidden");
      users.forEach(u=>{
        const el = document.createElement("div");
        el.className="border rounded-2xl p-3";
        el.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-2"><span class="font-semibold">${u.name}</span><span class="badge bg-slate-900 text-white">${u.role}</span></div>
            <div class="text-sm text-slate-500">login: <b class="font-mono">${u.username}</b></div>
          </div>
          <div class="flex items-center justify-between">
            <div class="text-sm text-slate-500">ID: <span class="font-mono">${u.id.slice(0,8)}…</span></div>
            <button class="del border rounded-lg px-3 py-1">Remover</button>
          </div>
        `;
        el.querySelector(".del").addEventListener("click", async ()=>{ await API.deleteUser(u.id); renderUsers(); });
        list.appendChild(el);
      });
    }
    $("#ucreate").addEventListener("click", async ()=>{
      const name=$("#uname").value.trim(), username=$("#uuser").value.trim(), password=$("#upass").value, role=$("#urole").value;
      if(!name||!username||!password) return alert("Preencha todos os campos.");
      await API.createUser({name,username,password,role});
      $("#uname").value=""; $("#uuser").value=""; $("#upass").value=""; $("#urole").value="SOLICITANTE";
      renderUsers();
    });

    async function renderAll(){
      // permissions -> hide tabs
      const isAdmin = currentUser.role==="ADMIN";
      const isAlmox = isAdmin || currentUser.role==="ALMOX";
      // show/hide buttons
      if(!isAlmox){ document.querySelector('.tab[data-t="cad"]').style.display="none"; }
      if(!isAdmin){ document.querySelector('.tab[data-t="usr"]').style.display="none"; }
      // default tab
      document.querySelector('.tab[data-t="itens"]').click();
      await renderItems();
      await renderSelectForReq();
      await renderReqs();
      await renderUsers();
    }
  </script>
</body>
</html>
